#!/usr/bin/env bash
set -euo pipefail

# Always run from the repository root
REPO_ROOT="$(git rev-parse --show-toplevel)"
cd "$REPO_ROOT"

echo "[husky] pre-commit: validating staged changes..."

# Ensure pnpm is available
if ! command -v pnpm >/dev/null 2>&1; then
  echo "[husky] pnpm is required but not found in PATH. Aborting commit." >&2
  exit 1
fi

# Run lint-staged
echo "[husky] Running lint-staged..."
pnpm exec lint-staged

# Skip heavy checks in fast mode
if [ -n "${FAST_COMMIT:-}" ]; then
  echo "[husky] FAST_COMMIT detected, skipping full checks."
  exit 0
fi

# Run full project checks for relevant files
STAGED_FILES=$(git diff --cached --name-only)
if echo "$STAGED_FILES" | grep -E '\.(ts|tsx|js|jsx)$|^package\.json$|^tsconfig\.json$|^eslint\.(js|cjs|mjs|ts)$' >/dev/null 2>&1; then
  echo "[husky] Running project checks (pnpm run check)..."
  pnpm run check
else
  echo "[husky] Skipping project checks (no relevant files staged)."
fi

echo "[husky] All pre-commit checks passed."