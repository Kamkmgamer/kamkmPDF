# Arabic Text Support for Netlify Serverless Functions

This document explains the comprehensive Arabic text support implementation for PDF generation in Netlify serverless functions.

## Overview

The system now fully supports Arabic text rendering in PDFs generated by serverless functions on Netlify. This includes:

- **Automatic Arabic text detection**
- **RTL (Right-to-Left) text direction handling**
- **Multiple Arabic font fallbacks**
- **Enhanced Chromium configuration for Arabic text rendering**
- **Proper Unicode bidirectional text support**

## Key Components

### 1. Netlify Configuration (`netlify.toml`)

```toml
[functions]
  # Include font files for Arabic text support
  included_files = ["public/fonts/**/*"]

# Headers for font loading
[[headers]]
  for = "/fonts/*"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"
    Access-Control-Allow-Origin = "*"
```

### 2. Arabic Text Utilities (`src/server/utils/arabicText.ts`)

The utility functions provide:

- **`containsArabic(text)`**: Detects Arabic characters in text
- **`containsRTL(text)`**: Detects RTL characters (Arabic, Hebrew, Persian, etc.)
- **`wrapArabicText(html)`**: Wraps Arabic text with proper HTML attributes
- **`getArabicFontFamily()`**: Returns the Arabic font family stack
- **`getArabicTextStyles()`**: Returns CSS styles for Arabic text rendering

### 3. Enhanced Puppeteer Configuration (`src/server/jobs/htmlToPdf.ts`)

The serverless function now uses enhanced Chromium arguments for better Arabic text rendering:

```typescript
const arabicSupportArgs = [
  ...chromium.args,
  "--font-render-hinting=medium",
  "--disable-font-subpixel-positioning",
  "--enable-font-antialiasing",
  "--disable-background-timer-throttling",
  // ... additional Arabic-specific optimizations
];
```

### 4. Font Support

The system includes multiple Arabic font fallbacks:

1. **Noto Naskh Arabic** - Primary Arabic font
2. **Noto Sans Arabic** - Secondary Arabic font
3. **Amiri** - Traditional Arabic font
4. **Scheherazade New** - Classical Arabic font
5. **Arabic Fallback** - System fonts with Arabic support
6. **Arial** - Final fallback

### 5. HTML Wrapper Enhancement (`src/server/ai/openrouter.ts`)

The HTML wrapper now includes:

- **Automatic Arabic text detection and wrapping**
- **Enhanced CSS with Arabic-specific styles**
- **Proper RTL direction handling**
- **Font feature settings for better rendering**

## How It Works

### 1. Text Detection

When a PDF generation request is made, the system automatically detects if the content contains Arabic text:

```typescript
const hasArabicText = containsArabic(opts.prompt ?? "");
```

### 2. Dynamic Styling

If Arabic text is detected, the system applies appropriate RTL styling:

```typescript
const directionStyle = hasArabicText
  ? "direction: auto; unicode-bidi: plaintext;"
  : "";
```

### 3. Font Loading

The system loads Arabic fonts from Google Fonts and applies them with proper fallbacks:

```css
font-family:
  "Noto Naskh Arabic", "Noto Sans Arabic", "Amiri", "Scheherazade New",
  "Arabic Fallback", Arial, sans-serif;
```

### 4. HTML Processing

Arabic text segments are automatically wrapped with proper attributes:

```html
<span dir="rtl" lang="ar" class="arabic-text">مرحبا بالعالم</span>
```

## Testing

Run the Arabic text utilities test:

```bash
npx tsx scripts/test-arabic.ts
```

This will verify:

- Arabic text detection
- RTL text detection
- Arabic text wrapping
- Font family configuration

## Deployment

### For Netlify

1. **Deploy the updated code** with the new `netlify.toml` configuration
2. **Ensure font files are included** in the deployment (if using local fonts)
3. **Test with Arabic content** to verify proper rendering

### Environment Variables

No additional environment variables are required. The Arabic text support works automatically based on content detection.

## Browser Support

The implementation works with:

- **Chromium-based browsers** (used by Puppeteer)
- **Modern browsers** with Unicode bidirectional text support
- **Serverless environments** (Netlify, Vercel, AWS Lambda)

## Unicode Ranges Supported

The system supports the following Arabic Unicode ranges:

- **U+0600-U+06FF**: Arabic
- **U+0750-U+077F**: Arabic Supplement
- **U+08A0-U+08FF**: Arabic Extended-A
- **U+FB50-U+FDFF**: Arabic Presentation Forms-A
- **U+FE70-U+FEFF**: Arabic Presentation Forms-B

## Performance Considerations

- **Font loading**: Google Fonts are loaded asynchronously
- **Memory usage**: Enhanced Chromium args are optimized for serverless environments
- **Rendering**: Font feature settings improve text rendering quality
- **Fallbacks**: Multiple font fallbacks ensure compatibility

## Troubleshooting

### Arabic Text Not Rendering

1. Check if the text contains Arabic characters using `containsArabic()`
2. Verify font loading in browser developer tools
3. Ensure proper HTML attributes (`dir="rtl"`, `lang="ar"`)

### RTL Direction Issues

1. Verify `unicode-bidi: plaintext` is applied
2. Check CSS direction properties
3. Test with mixed LTR/RTL content

### Font Loading Issues

1. Check network connectivity for Google Fonts
2. Verify font fallbacks are available
3. Test with different Arabic fonts

## Future Enhancements

Potential improvements:

- **Local font embedding** for offline support
- **Additional RTL language support** (Hebrew, Persian, Urdu)
- **Advanced typography features** (ligatures, kerning)
- **Performance optimizations** for large Arabic documents

## Conclusion

The Arabic text support implementation provides comprehensive RTL text rendering for PDF generation in Netlify serverless functions. The system automatically detects Arabic content and applies appropriate styling, fonts, and direction handling to ensure proper rendering in generated PDFs.
